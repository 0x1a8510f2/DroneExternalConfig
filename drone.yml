kind: pipeline
type: docker
name: default

steps:
- name: build binaries
  image: docker.io/golang:1.15-alpine
  commands:
    - mkdir -p build/linux-amd64 build/linux-arm64
    - GOOS=linux GOARCH=amd64 go build -v -o build/linux-amd64 .
    - GOOS=linux GOARCH=arm64 go build -v -o build/linux-arm64 .

- name: build and push amd64 docker image
  image: plugins/docker:linux-amd64
  detach: true
  settings:
    username:
      from_secret: DOCKER_USER
    password:
      from_secret: DOCKER_TOKEN
    dockerfile: ./Dockerfile.linux-arm64
    repo: trslimey/drone-external-config
    tags:
      - amd64

- name: build and push arm64 docker image
  image: plugins/docker:linux-arm64
  detach: true
  settings:
    username:
      from_secret: DOCKER_USER
    password:
      from_secret: DOCKER_TOKEN
    dockerfile: ./Dockerfile.linux-arm64
    repo: trslimey/drone-external-config
    tags:
      - arm64